name: Streamlit Daily Wake up (Selenium)

on:
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯æ—¥ 3:00 å’Œ 15:00 (å³ UTC 19:00 å’Œ 7:00)
    - cron: '0 7,19 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  wake_up:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true 

      # --- ç¬¬ä¸€é˜¶æ®µï¼šå°è¯•é€šè¿‡ Git æäº¤è§¦å‘åç«¯é‡éƒ¨ç½² (å¯é€‰ï¼Œä½œä¸ºåŒé‡ä¿é™©) ---
      - name: Git Auto-Commit to Trigger Build
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # å†™å…¥å½“å‰æ—¶é—´åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œç¡®ä¿æ–‡ä»¶æœ‰å®è´¨æ€§å˜åŒ–
          echo "Wake up trigger: $(date)" > last_waked_up.log
          
          git add last_waked_up.log
          git commit -m "Auto-wake: update timestamp" || echo "No changes to commit"
          
          # æ‹‰å–æœ€æ–°ä»£ç é˜²æ­¢å†²çªï¼Œç„¶åæ¨é€
          git pull --rebase
          git push

      # --- ç¬¬äºŒé˜¶æ®µï¼šç¯å¢ƒå‡†å¤‡ ---
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Selenium and Chrome Driver
        run: |
          pip install selenium webdriver-manager

      # --- ç¬¬ä¸‰é˜¶æ®µï¼šä½¿ç”¨ Selenium æ¨¡æ‹Ÿæµè§ˆå™¨ç‚¹å‡»å”¤é†’ ---
      - name: Wake up Streamlit with Selenium
        env:
          # !!! è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸ºä½ è‡ªå·±çš„ Streamlit App é“¾æ¥ !!!
          TARGET_URL: 'https://axxsxx.streamlit.app/'
        run: |
          python <<EOF
          import os
          import time
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By
          
          # è·å– URL
          url = os.environ.get("TARGET_URL")
          print(f"ğŸš€ Starting Selenium to visit: {url}")

          # é…ç½®æ— å¤´ Chrome æµè§ˆå™¨ (Headless Chrome)
          chrome_options = Options()
          chrome_options.add_argument("--headless") 
          chrome_options.add_argument("--no-sandbox")
          chrome_options.add_argument("--disable-dev-shm-usage")
          chrome_options.add_argument("--disable-gpu")
          
          # åˆå§‹åŒ–æµè§ˆå™¨
          driver = webdriver.Chrome(options=chrome_options)
          
          try:
              driver.get(url)
              print("Page loaded. Waiting 10s for JavaScript execution...")
              time.sleep(10) # ç­‰å¾…é¡µé¢åŠ è½½
              
              print(f"Page Title: {driver.title}")
              
              # æŸ¥æ‰¾æ‰€æœ‰çš„æŒ‰é’®
              buttons = driver.find_elements(By.TAG_NAME, "button")
              clicked = False
              
              # éå†æŒ‰é’®ï¼Œå¯»æ‰¾å”¤é†’æŒ‰é’®
              for btn in buttons:
                  btn_text = btn.text
                  # Streamlit çš„å”¤é†’æŒ‰é’®é€šå¸¸åŒ…å« "Yes" æˆ– "wake"
                  if "Yes" in btn_text or "wake" in btn_text or "Back up" in btn_text:
                      print(f"ğŸ’¤ Found sleeping button: '{btn_text}', clicking it now...")
                      btn.click()
                      clicked = True
                      
                      # ç‚¹å‡»åç­‰å¾…åº”ç”¨é‡å¯
                      print("â³ Waiting 20s for app to restart...")
                      time.sleep(20)
                      break
              
              if not clicked:
                  print("âœ… No wake-up button found. The app is likely already running.")
                  
              # å†æ¬¡æ‰“å°æ ‡é¢˜ç¡®è®¤çŠ¶æ€
              print(f"Final Page Title: {driver.title}")

          except Exception as e:
              print(f"âŒ Error occurred: {e}")
              exit(1)
          finally:
              driver.quit()
          EOF

      # --- ç¬¬å››é˜¶æ®µï¼šé€šçŸ¥ ---
      - name: Send Telegram notification on success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_TO }}
          message: |
            âœ… Streamlit å”¤é†’ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼
            
            åº”ç”¨é“¾æ¥: https://axxsxx.streamlit.app/
            è§¦å‘æ—¶é—´: (UTC ${{ github.event.schedule }})
            
            å·²æ‰§è¡Œ Selenium æ¨¡æ‹Ÿè®¿é—®ä¸ç‚¹å‡»ã€‚

      - name: Send Telegram notification on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_TO }}
          message: |
            âŒ Streamlit å”¤é†’ä»»åŠ¡å¤±è´¥ï¼
            
            Selenium è„šæœ¬æ‰§è¡Œå‡ºé”™ï¼Œè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ã€‚
